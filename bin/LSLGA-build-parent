#!/usr/bin/env python

"""Generate the parent sample of large galaxies.

Read 1436176 objects from /Users/ioannis/research/projects/LSLGA/sample/v2.0/hyperleda-d25min10-18nov14.fits
Read 1436176 objects from /Users/ioannis/research/projects/LSLGA/sample/v2.0/hyperleda-d25min10-18nov14-allwise.fits
  Identified 1379531/1436176 (96.06%) objects with AllWISE photometry.
  Removed 13273/1436176 (0.92%) objects with no magnitude estimate.
  Removed 887102/1422903 (62.34%) objects with D(25) < 20.000 arcsec and D(25) > 10000.000 arcmin.
  Removed 509/535801 (0.09%) low surface-brightness galaxies.
  Removed 2585/535292 (0.48%) SDSS galaxies inside another large galaxy.
Read 20070 DESI tiles from /Users/ioannis/research/projects/LSLGA/sample/desi-tiles.fits
  Identified 287853/532707 (54.04%) galaxies inside and 244854/532707 (45.96%) galaxies outside the DESI footprint.
Read 2557319 Tycho-2 stars with B<99.0.
  Found 6068/532707 (1.14%) galaxies near a bright (Tycho-2) star.
Final sample size: 532707 galaxies.
Writing 532707 galaxies to /Users/ioannis/research/projects/LSLGA/sample/v2.0/LSLGA-v2.0.fits
Writing /Users/ioannis/research/projects/LSLGA/sample/v2.0/LSLGA-v2.0.kd.fits

"""
import os, sys, argparse
import numpy as np

import astropy.table

import LSLGA.io
import LSLGA.misc

def build_parent(d25min=20/60, d25max=1e4, verbose=False):
    """Build the parent catalog.
    
    """
    from astropy.table import Column
    from astrometry.libkd.spherematch import tree_build_radec, tree_search_radec

    version = LSLGA.io.parent_version()
    sandboxdir = os.path.join(LSLGA.io.sample_dir(), version, 'sandbox')
    if not os.path.isdir(sandboxdir):
        os.makedirs(sandboxdir, exist_ok=True)

    # Read the full Hyperleda catalog and assign a unique ID.
    leda = LSLGA.io.read_hyperleda(verbose=True)
    parent = leda.copy()
    parent.add_column(Column(name='LSLGA_ID', length=len(parent), dtype='i8'), index=0)
    parent['LSLGA_ID'] = np.arange(len(parent))

    # Require a magnitude estimate.
    magcut = np.isfinite( parent['MAG'] )
    print('  Removed {}/{} ({:.2f}%) objects with no magnitude estimate.'.format(
        np.sum(~magcut), len(parent), 100*np.sum(~magcut)/len(parent)))
    parent[~magcut].write(os.path.join(sandboxdir, 'LSLGA-{}-nomagnitude.fits'.format(version)), overwrite=True)
    parent = parent[magcut]

    # Apply a minimum diameter cut.
    diamcut = (parent['D25'] >= d25min) * (parent['D25'] <= d25max)
    print('  Removed {}/{} ({:.2f}%) objects with D(25) < {:.3f} arcsec and D(25) > {:.3f} arcmin.'.format(
        np.sum(~diamcut), len(parent), 100*np.sum(~diamcut)/len(parent), d25min*60, d25max))
    parent[~diamcut].write(os.path.join(sandboxdir, 'LSLGA-{}-diamcut.fits'.format(version)), overwrite=True)
    parent = parent[diamcut]

    # Apply a surface brightness cut.
    lsbcut = (parent['SB_D25'] > 27) * (parent['D25'] > 0.95)
    print('  Removed {}/{} ({:.2f}%) low surface-brightness galaxies.'.format(
        np.sum(lsbcut), len(parent), 100*np.sum(lsbcut)/len(parent)))
    parent[lsbcut].write(os.path.join(sandboxdir, 'LSLGA-{}-lsb.fits'.format(version)), overwrite=True)
    parent = parent[~lsbcut]

    # Toss out all SDSS galaxies "inside" another galaxy.  Most of these are
    # spurious and the ones that are not will hopefully be fixed by visual
    # inspection and/or will be picked up by the standard pipeline.
    kdparent = tree_build_radec( parent['RA'], parent['DEC'] )
    sdssingal = np.zeros( len(parent), dtype=bool)
    for pp in parent:
        I = tree_search_radec(kdparent, pp['RA'], pp['DEC'], pp['D25'] / 1.8 / 60) # 1.8 instead of 2...
        if len(I) > 1:
            isdss = np.array(['SDSS' in gg for gg in parent['GALAXY'][I]])
            if np.sum(isdss) > 0:
                sdssingal[I[isdss]] = True
    print('  Removed {}/{} ({:.2f}%) SDSS galaxies inside another large galaxy.'.format(
        np.sum(sdssingal), len(parent), 100*np.sum(sdssingal)/len(parent)))    
    parent[sdssingal].write(os.path.join(sandboxdir, 'LSLGA-{}-sdss-in-largegal.fits'.format(version)), overwrite=True)
    parent = parent[~sdssingal]

    # Flag galaxies in and out of the DESI footprint.
    tiles = LSLGA.io.read_desi_tiles(verbose=verbose)
    indesi = LSLGA.misc.is_point_in_desi(tiles, parent['RA'], parent['DEC']).astype(bool)

    print('  Identified {}/{} ({:.2f}%) galaxies inside and {}/{} ({:.2f}%) galaxies outside the DESI footprint.'.format(
        np.sum(indesi), len(parent), 100*np.sum(indesi)/len(parent), np.sum(~indesi), len(parent),
        100*np.sum(~indesi)/len(parent)))
    parent['IN_DESI'] = indesi
    
    # Flag galaxies near bright stars.
    tycho = LSLGA.io.read_tycho(verbose=True)
    kdparent = tree_build_radec( parent['RA'], parent['DEC'] )

    nearstar = np.zeros( len(parent) ).astype(bool)
    for star in tycho:
        I = tree_search_radec(kdparent, star['RA'], star['DEC'], star['RADIUS'])
        if len(I) > 0:
            nearstar[I] = True
    print('  Found {}/{} ({:.2f}%) galaxies near a bright (Tycho-2) star.'.format(
        np.sum(nearstar), len(parent), 100*np.sum(nearstar)/len(parent)))
    parent['NEAR_BRIGHTSTAR'] = nearstar

    # Remove some unnecessary columns
    parent.remove_columns(('OBJTYPE', 'BT', 'VT', 'IT', 'KT', 'MODBEST',
                           'DIAM_ISO', 'BA_ISO', 'DIAM_B', 'BA_B', 'DIAM_V', 'BA_V',
                           'DIAM_R', 'BA_R', 'DIAM_I', 'BA_I', 'DIAM_K', 'BA_K'))

    print('Final sample size: {} galaxies.'.format(len(parent)))

    return parent, kdparent

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--d25min', type=float, default=10/60, help='Minimum diameter [arcmin].')
    parser.add_argument('--d25max', type=float, default=1e4, help='Maximum diameter [arcmin].')
    parser.add_argument('--verbose', action='store_true', help='Be verbose!')
    parser.add_argument('--clobber', action='store_true', help='Overwrite existing files.')
    args = parser.parse_args()

    parentfile = LSLGA.io.get_parentfile()
    kdparentfile = LSLGA.io.get_parentfile(kd=True)
    
    if os.path.isfile(parentfile) and not args.clobber:
        print('Output file {} exists; use clobber.'.format(parentfile))
        sys.exit(1)

    parent, kdparent = build_parent(verbose=args.verbose)

    if args.verbose:
        print('Writing {} galaxies to {}'.format(len(parent), parentfile))
    parent.write(parentfile, overwrite=True)

    if args.verbose:
        print('Writing {}'.format(kdparentfile))
    cmd = 'startree -i {} -o {} -T -P -k -n largegals'.format(parentfile, kdparentfile)
    #print(cmd)
    _ = os.system(cmd)

if __name__ == '__main__':
    main()

