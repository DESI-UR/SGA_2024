#!/usr/bin/env python

"""Run the LSLGA pipeline on the MaNGA-NSA sample.

import pickle
from legacyhalos.ellipse import ellipse_sbprofile
with open('cgcg004-096/cgcg004-096-ellipsefit.p', 'rb') as ff:
    res = pickle.load(ff)
prof = ellipse_sbprofile(res)            
with open('cgcg004-096/cgcg004-096-sbprofile.p', 'wb') as out:
    pickle.dump(prof, out)

"""
import os, argparse, sys, time
import pdb
import numpy as np
import matplotlib.pyplot as plt

import fitsio
from astropy.table import Table, hstack
from astrometry.util.fits import fits_table
from legacypipe.survey import LegacySurveyData

import LSLGA.io
import LSLGA.misc

mangadir = os.path.join(os.getenv('IM_PROJECTS_DIR'), 'manga-nsa')
samplefile = os.path.join(mangadir, 'manga-nsa.fits')

def missing_files(sample, filedir='.', filetype='coadds',
                  size=1, clobber=False):
    """Find missing data of a given filetype."""    

    if filetype == 'coadds':
        filesuffix = 'pipeline-resid.jpg'
    elif filetype == 'custom_coadds':
        filesuffix = 'custom-resid.jpg'
    elif filetype == 'ellipse':
        filesuffix = 'ellipsefit.p'
    elif filetype == 'html':
        filesuffix = 'junk'
    else:
        print('Unrecognized file type!')
        raise ValueError

    ngal = len(sample)
    indices = np.arange(ngal)
    todo = np.ones(ngal, dtype=bool)

    for ii, onegal in enumerate(np.atleast_1d(sample)):
        galaxy = onegal['PLATEIFU'].decode('utf-8')
        checkfile = os.path.join(filedir, galaxy, '{}-{}'.format(galaxy, filesuffix))
        if os.path.exists(checkfile) and clobber is False:
            todo[ii] = False

    if np.sum(todo) == 0:
        return list()
    else:
        indices = indices[todo]
        
    return np.array_split(indices, size)

def build_sample(clobber=False):
    """Build the parent sample for this project.

    plate-ifu ra dec
    7815-6104 319.193098655 11.0437407875
    http://legacysurvey.org/viewer?ra=319.1930&dec=11.0436&zoom=14&layer=decals-dr7
    
    8256-12704 166.129407835 42.6245544187
    http://legacysurvey.org/viewer?ra=166.1354&dec=42.6264&zoom=14&layer=mzls+bass-dr6
    
    8939-9101 125.227739446 23.7292001251
    http://legacysurvey.org/viewer?ra=125.2275&dec=23.7291&zoom=14&layer=decals-dr7

    """
    import fitsio

    mangafile = os.path.join(mangadir, 'drpall-v2_1_2.fits')
    nsafile = os.path.join(mangadir, 'nsa_v1_0_1.fits')

    if os.path.exists(samplefile) and clobber is False:
        print('Sample file {} exists; clobber?'.format(samplefile))
        return

    allmanga = Table(fitsio.read(mangafile, upper=True))
    allplateifu = [pfu.strip() for pfu in allmanga['PLATEIFU']]
    these = np.where( np.isin(allplateifu, ['7815-6104', '8256-12704', '8939-9101']) )[0]
    manga = allmanga[these]

    rows = np.array([mid[2:] for mid in manga['MANGAID']])
    srt = np.argsort(rows)
    manga = manga[srt]
    nsa = Table(fitsio.read(nsafile, rows=rows[srt], upper=True))
    nsa.rename_column('PLATE', 'PLATE_NSA')

    sample = hstack( (manga, nsa) )
    
    print('Writing {}'.format(samplefile))
    sample.write(samplefile, overwrite=clobber)

    return sample

def main():

    parser = argparse.ArgumentParser()
    parser.add_argument('--nproc', default=4, type=int, help='number of multiprocessing processes.')
    parser.add_argument('--pixscale', default=0.262, type=float, help='pixel scale (arcsec/pix).')

    parser.add_argument('--build-sample', action='store_true', help='Build and write out the sample.')
    parser.add_argument('--coadds', action='store_true', help='Build the pipeline coadds.')
    parser.add_argument('--custom-coadds', action='store_true', help='Build the custom coadds.')
    parser.add_argument('--ellipse', action='store_true', help='Do the ellipse fitting.')
    parser.add_argument('--html', action='store_true', help='Make plots for the webpage!')

    parser.add_argument('--force', action='store_true', help='Use with --coadds; ignore previous pickle files.')
    parser.add_argument('--count', action='store_true', help='Count how many objects are left to analyze and then return.')
    parser.add_argument('--nomakeplots', action='store_true', help='Do not remake the QA plots.')
    parser.add_argument('--debug', action='store_true', help='Log to STDOUT and build debugging plots.')
    parser.add_argument('--verbose', action='store_true', help='Be verbose!')
    parser.add_argument('--clobber', action='store_true', help='Overwrite existing files.')                                
    args = parser.parse_args()

    #analysisdir = legacyhalos.io.hsc_vs_decals_dir()

    # Write out the sample.
    if args.build_sample:
        sample = build_sample(clobber=args.clobber)
        sys.exit(1)

    # Figure out what's left to do.
    print('Reading {}'.format(samplefile))
    #sample = legacyhalos.io.read_hsc_vs_decals(verbose=args.verbose)
    sample = Table.read(samplefile)
    
    groups, suffix = [], ''
    if args.coadds:
        suffix = 'coadds'
        groups = missing_files(sample, filedir=mangadir, filetype=suffix, clobber=args.clobber)
    elif args.custom_coadds:
        suffix = 'custom_coadds'
        groups = missing_files(sample, filedir=mangadir, filetype=suffix, clobber=args.clobber)
    elif args.ellipse:
        suffix = 'ellipse'
        groups = missing_files(sample, filedir=mangadir, filetype=suffix, clobber=args.clobber)
    elif args.html:
        suffix = 'html'
        groups = missing_files(sample, filedir=mangadir, filetype=suffix, clobber=args.clobber)
    else:
        groups = []

    if len(groups) == 0:
        ntodo = 0
    else:
        ntodo = len(np.hstack(np.atleast_1d(groups)))
        
    if ntodo == 0:
        print('{} for all {} galaxies are complete!'.format(
            suffix.upper(), len(sample)), flush=True)
        return
    else:
        print('{} left to do: {} / {} divided across {} group(s).'.format(
            suffix.upper(), ntodo, len(sample), len(groups)), flush=True)

    print('Starting {} {} at {}'.format(ntodo, suffix.upper(), time.asctime()), flush=True)
    
    # Generate the pipeline coadds.
    if args.coadds:
        from LSLGA.coadds import pipeline_coadds
        survey = LegacySurveyData()

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['PLATEIFU']
            survey.output_dir = os.path.join(mangadirdir, galaxy)
            
            radius = np.round(40 / args.pixscale).astype('int') # [pixels]
            err = pipeline_coadds(onegal, galaxy=galaxy, radius=radius, survey=survey,
                                  pixscale=args.pixscale, nproc=args.nproc, force=args.force)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)

    if args.custom_coadds:
        from legacyhalos.coadds import custom_coadds
        survey = LegacySurveyData()

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['GALAXY'].lower()

            survey.output_dir = os.path.join(analysisdir, galaxy)
            survey.ccds = fits_table(os.path.join(survey.output_dir, '{}-ccds.fits'.format(galaxy)))

            radius = legacyhalos.misc.cutout_radius_150kpc( 
                redshift=onegal['Z'], pixscale=args.pixscale) # [pixels]
            
            err = custom_coadds(onegal, galaxy=galaxy, radius=radius, survey=survey,
                                pixscale=args.pixscale, nproc=args.nproc, verbose=args.verbose)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)

    if args.ellipse:
        from legacyhalos.ellipse import legacyhalos_ellipse

        for ii in groups:
            t0 = time.time()

            onegal = sample[ii][0]
            galaxy = onegal['GALAXY'].lower()
            galaxydir = os.path.join(analysisdir, galaxy)

            err = legacyhalos_ellipse(onegal, galaxydir=galaxydir, pixscale=args.pixscale, 
                                      verbose=args.verbose)
            if err == 0:
                print('ERROR: {}; please check the logfile.'.format(galaxy), flush=True)
            print('Finished galaxy {} in {:.3f} minutes.'.format(
                galaxy, (time.time() - t0) / 60), flush=True)

    if args.html:
        from legacyhalos.hsc import make_html

        survey = LegacySurveyData()

        htmldir = os.path.join(analysisdir, 'html')
        make_html(sample, analysisdir=analysisdir, htmldir=htmldir, clobber=args.clobber,
                  verbose=args.verbose, pixscale=args.pixscale, nproc=args.nproc,
                  survey=survey, makeplots=not args.nomakeplots)
        print('HTML pages written to {}'.format(htmldir))

        if 'NERSC_HOST' in os.environ:
            print('Execute the following command to publish the webpage.')
            print('rsync -auvP --delete {}/* /project/projectdirs/cosmo/www/temp/ioannis/hsc-vs-decals/'.format(
                htmldir))

if __name__ == '__main__':
    main()

