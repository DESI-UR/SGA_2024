#!/usr/bin/env python

"""Generate the sample of large galaxies in DR6+DR7.

% LSLGA-build-drsample --clobber --verbose

"""
import os, sys, argparse, time
from time import time
import numpy as np

import LSLGA.io
import LSLGA.misc
from legacypipe.survey import LegacySurveyData

import multiprocessing
maxnproc = multiprocessing.cpu_count() // 2

def get_masked_pixels(ccds, survey, wcs, debug=False):
    """Given an (input) set of CCDS (restricted, one supposes, to a large-galaxy
    cutout), compute the fraction of interpolated and saturated pixels.

    """
    nccd = len(ccds)
    W, H = wcs.get_width(), wcs.get_height()
    radecpoly = np.array([wcs.pixelxy2radec(x,y) for 
                          x, y in [(1, 1), (W, 1), (W, H), (1, H), (1, 1)]])
    for ii, ccd in enumerate(ccds):
        im = survey.get_image_object(ccd)
        x0, x1, y0, y1, slc = im.get_image_extent(wcs=im.get_wcs(), radecpoly=radecpoly)
        dq = im.read_dq(slice=slc)

        ccds.galaxy_npix[ii] = dq.size
        ccds.galaxy_fracsatur[ii] = np.sum(dq == 4) / dq.size  # saturated
        ccds.galaxy_fracinterp[ii] = np.sum(dq == 8) / dq.size # interpolated
        if debug:
            print(ii, ccd.filter, 100 * ccds.galaxy_fracsatur[ii], 100 * ccds.galaxy_fracinterp[ii])
            plt.imshow( (dq & 8 != 0), origin='lower')
            plt.show()
            
    return ccds

def simple_wcs(onegal, diam, PIXSCALE=0.262):
    """Build a simple WCS object for a single galaxy.

    """
    from astrometry.util.util import Tan
    size = np.rint(diam * 60 / PIXSCALE).astype('int') # [pixels]
    wcs = Tan(onegal['RA'], onegal['DEC'], size/2+0.5, size/2+0.5,
                 -PIXSCALE/3600.0, 0.0, 0.0, PIXSCALE/3600.0, 
                 float(size), float(size))
    
    return wcs

def _build_drsample_one(args):
    """Wrapper function for the multiprocessing."""
    return build_drsample_one(*args)

def build_drsample_one(onegal, survey_dr6, survey_dr7, dr6_dec, dr7_dec, verbose=False):
    """Wrapper function to find overlapping grz CCDs for a single galaxy.
    
    """
    idr6 = (onegal['DEC'] >= dr6_dec[0]) * (onegal['DEC'] <= dr6_dec[1])
    idr7 = (onegal['DEC'] >= dr7_dec[0]) * (onegal['DEC'] <= dr7_dec[1])

    if idr6 or idr7:
        diam = 1.0 * onegal['D25'] # [arcmin]
        wcs = simple_wcs(onegal, diam)

    # Choose DR7 over DR6
    ccds = None
    if idr7:
        dr = 'dr7'
        survey = survey_dr7
        ccds = survey_dr7.ccds_touching_wcs(wcs, ccdrad=None)
        
    if idr6 and not idr7:
        dr = 'dr6'
        survey = survey_dr6
        ccds = survey_dr6.ccds_touching_wcs(wcs, ccdrad=None)

    if ccds is None or (not idr6 and not idr7):
        return [None, None]

    if 'g' in ccds.filter and 'r' in ccds.filter and 'z' in ccds.filter:
        nccd = len(ccds)

        ccds.galaxy_npix = np.zeros(nccd).astype('int') # number of pixels in cutout
        ccds.galaxy_fracsatur = np.zeros(nccd).astype('f4')
        ccds.galaxy_fracinterp = np.zeros(nccd).astype('f4')
        ccds.lslga_id = np.zeros(nccd).astype('i8') + onegal['LSLGA_ID']

        onegal['DR'] = dr.upper()

        if diam >= 1.0:
            ccds = get_masked_pixels(ccds, survey, wcs)

        if verbose:
            print('{}: {} CCDs, RA = {:.5f}, Dec = {:.5f}, Diameter={:.4f} arcmin'.format(
                    onegal['GALAXY'], len(ccds), onegal['RA'], onegal['DEC'], diam))
            sys.stdout.flush()
        return [onegal, ccds]
    else:
        return [None, None]

def build_drsample(cat, kdcat, nproc=1, verbose=False):
    """Build the full sample of galaxies with grz coverage in DR6+DR7.
    
    """
    from glob import glob
    import healpy as hp
    from astropy.table import vstack, Column
    from astrometry.util.fits import fits_table, merge_tables
    #from astrometry.libkd.spherematch import trees_match
    
    cat.add_column(Column(name='DR', length=len(cat), dtype='S3'))

    sampledir = LSLGA.io.sample_dir()
    dr6_ccdsfile = glob(os.path.join(sampledir, 'survey-ccds-dr6*.fits'))[0]
    dr7_ccdsfile = glob(os.path.join(sampledir, 'survey-ccds-dr7*.fits'))[0]

    # To speed up the matching, assign the input catalog and CCDs file to
    # nside=256 healpixels (0.0525 deg^2 or 0.23 deg per side) and only keep the
    # matching objects.
    nside = 256

    t0 = time()
    dr6_ccds = fits_table(dr6_ccdsfile)
    print('Read {} CCDs from {} in {:.1f} s'.format(len(dr6_ccds), dr6_ccdsfile, time()-t0))

    cat_allpix = LSLGA.misc.radec2pix(nside, cat['RA'].data, cat['DEC'].data)

    def get_galaxy_ccds(ccds):
        allpix = LSLGA.misc.radec2pix(nside, ccds.ra, ccds.dec)
        pix = np.unique(allpix) # add the neighboring healpixels
        pix = np.unique( np.hstack( (pix, hp.pixelfunc.get_all_neighbours(nside, pix, nest=True).flatten()) ) )
        if np.sum(pix == -1) > 0: # remove "no neighbors" healpixel
            pix = np.delete(pix, np.where(pix == -1)[0])
        indx = np.where( np.isin(cat_allpix, pix) )[0]
        return indx

    #dr6_pix = get_ccds_pix(dr6_ccds)
    #dr6_keep = np.where( np.isin(cat_allpix, dr6_pix) )[0]
    #cat_allpix = LSLGA.misc.radec2pix(nside, cat['RA'][dr6_keep].data, cat['DEC'][dr6_keep].data)

    # Which galaxies have grz coverage?
    dr6_keep = None
    for band in ('g', 'r', 'z'):
        indx = get_galaxy_ccds(dr6_ccds[dr6_ccds.filter == band])
        if dr6_keep is None:
            dr6_keep = indx
        else:
            dr6_keep = np.intersect1d(dr6_keep, indx)
        print(band, len(indx), len(dr6_keep))

    test = get_galaxy_ccds(dr6_ccds)
    print(len(test))
            
    import matplotlib.pyplot as plt
    #plt.scatter(dr6_ccds.ra, dr6_ccds.dec, s=1, label='All CCDs')
    plt.scatter(cat['RA'][test], cat['DEC'][test], s=5, marker='s', label='Any band')
    plt.scatter(cat['RA'][dr6_keep], cat['DEC'][dr6_keep], s=1, alpha=0.5, label='grz')
    plt.legend()
    plt.show()

    #rr, dd = LSLGA.misc.pix2radec(nside, dr6_pix)
    #plt.scatter(rr, dd, s=1, alpha=0.5)

    import pdb ; pdb.set_trace()
    


    t0 = time()
    dr7_ccds = fits_table(dr7_ccdsfile)
    print('Read {} CCDs from {} in {:.1f} s'.format(len(dr7_ccds), dr7_ccdsfile, time()-t0))
    
    #dr6_ccds = survey_dr6.get_ccds()
    #dr7_ccds = survey_dr7.get_ccds()

    import pdb ; pdb.set_trace()

    # Speed things up by restricting the sample to the set of galaxies within 1
    # arcmin of any CCD.
    kddr7 = survey_dr7.get_ccd_kdtrees()[0][1]
    I, J, d = trees_match(kdcat, kddr7, np.radians(1/60))

    # Read the CCDs files here to get the declination boundaries of each DR.
    import pdb ; pdb.set_trace()

    survey_dr6 = LegacySurveyData(survey_dir=sampledir, verbose=False)
    survey_dr7 = LegacySurveyData(survey_dir=sampledir, verbose=False)

    dr6_ccds = survey_dr6.get_ccds()
    dr7_ccds = survey_dr7.get_ccds()
    dr6_dec = (dr6_ccds.dec.min(), dr6_ccds.dec.max())
    dr7_dec = (dr7_ccds.dec.min(), dr7_ccds.dec.max())
    
    sampleargs = list()
    for gg in cat:
        sampleargs.append( (gg, survey_dr6, survey_dr7, dr6_dec, dr7_dec, verbose) )

    if nproc > 1:
        p = multiprocessing.Pool(nproc)
        result = p.map(_build_drsample_one, sampleargs)
        p.close()
    else:
        result = list()
        for args in sampleargs:
            result.append(_build_drsample_one(args))
    
    # Remove non-matching objects and write out the sample
    rr = list(zip(*result))    
    outcat = vstack(list(filter(None, rr[0])))
    outccds = merge_tables( list(filter(None, rr[1])), columns='minimal')
    
    return outcat, outccds

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--dr', type=str, default='dr6-dr7', help='Data release.')
    parser.add_argument('--nproc', type=int, default=1, help='Number of processors to use.')
    parser.add_argument('--d25min', type=float, default=None, help='Minimum diameter [arcmin].')
    parser.add_argument('--d25max', type=float, default=None, help='Maximum diameter [arcmin].')
    parser.add_argument('--verbose', action='store_true', help='Be verbose!')
    parser.add_argument('--clobber', action='store_true', help='Overwrite existing files.')
    args = parser.parse_args()

    drsamplefile = LSLGA.io.get_parentfile(dr=args.dr, d25min=args.d25min, d25max=args.d25max)
    drccdsfile = LSLGA.io.get_parentfile(dr=args.dr, ccds=True, d25min=args.d25min, d25max=args.d25max)
    if os.path.isfile(drsamplefile) and not args.clobber:
        print('Output file {} exists; use clobber.'.format(drsamplefile))
        sys.exit(1)
        
    parent = LSLGA.io.read_parent(verbose=args.verbose)
    if args.d25min is not None:
        parent = parent[parent['D25'] >= args.d25min]
        if args.verbose:
            print('Cutting sample to {} galaxies with D(25) >= {:.2f} arcmin'.format(
                len(parent), args.d25min))
    if args.d25max is not None:
        parent = parent[parent['D25'] <= args.d25max]
        if args.verbose:
            print('Cutting sample to {} galaxies with D(25) <= {:.2f} arcmin'.format(
                len(parent), args.d25max))

    #kdparent = LSLGA.io.read_parent(verbose=args.verbose, kd=True)
    #rand = np.random.RandomState(seed=1)
    #parent = parent[rand.choice(len(parent), size=10000)]

    if args.nproc > maxnproc:
        print('Number of requested cores {} exceeds the maximum available {}.'.format(
            args.nproc, maxnproc))
        sys.exit(1)

    t0 = time()
    drsample, drccds = build_drsample(parent, nproc=args.nproc, verbose=args.verbose)
    
    if args.verbose:
        print('Found {}/{} galaxies in the DR6+DR7 footprint.'.format(len(drsample), len(parent)))
        print('Total time = {:.3f} minutes.'.format( (time() - t0) / 60 ) )

    if args.verbose:
        print('Writing {} galaxies to {}'.format(len(drsample), drsamplefile))
    drsample.write(drsamplefile, overwrite=True)

    if args.verbose:
        print('Writing {} CCDs to {}'.format(len(drccds), drccdsfile))
    drccds.writeto(drccdsfile, overwrite=True)

if __name__ == '__main__':
    main()

