#!/usr/bin/env python
"""MPI wrapper for the NLSA

"""
import matplotlib
matplotlib.use('Agg')

import os, sys, time, pdb
import argparse
import numpy as np
from astropy.table import Table, hstack
from contextlib import redirect_stdout, redirect_stderr

from astrometry.util.fits import fits_table
from legacypipe.survey import LegacySurveyData

#import legacyhalos.io
#import legacyhalos.hsc
#import legacyhalos.coadds
#import legacyhalos.html
#import legacyhalos.integrate
#from legacyhalos.misc import RADIUS_CLUSTER_KPC

def get_survey_dir(onegal):
    if onegal['RELEASE'] == 6000:
        return '/global/project/projectdirs/cosmo/work/legacysurvey/dr6'
    elif onegal['RELEASE'] == 7000 or onegal['RELEASE'] == 7001:
        return '/global/project/projectdirs/cosmo/work/legacysurvey/dr7'
    else:
        print('Unrecognized DR!')
        raise ValueError
    return

def missing_files(sample, filetype='coadds', size=1, htmldir=None,
                  clobber=False):
    """Find missing data of a given filetype."""    

    if filetype == 'coadds':
        filesuffix = '-pipeline-resid-grz.jpg'
    elif filetype == 'custom_coadds':
        filesuffix = '-custom-resid-grz.jpg'
    elif filetype == 'ellipse':
        filesuffix = '-ellipsefit.p'
    elif filetype == 'sersic':
        filesuffix = '-sersic-single.p'
    elif filetype == 'html':
        filesuffix = '-ccdpos.png'
        #filesuffix = '-sersic-exponential-nowavepower.png'
    else:
        print('Unrecognized file type!')
        raise ValueError

    ngal = len(sample)
    indices = np.arange(ngal)
    todo = np.ones(ngal, dtype=bool)

    if filetype == 'html':
        galaxy, _, galaxydir = legacyhalos.io.get_galaxy_galaxydir(sample, htmldir=htmldir, html=True)
    else:
        galaxy, galaxydir = legacyhalos.io.get_galaxy_galaxydir(sample, htmldir=htmldir)

    for ii, (gal, gdir) in enumerate( zip(np.atleast_1d(galaxy), np.atleast_1d(galaxydir)) ):
        checkfile = os.path.join(gdir, '{}{}'.format(gal, filesuffix))
        if os.path.exists(checkfile) and clobber is False:
            todo[ii] = False

    if np.sum(todo) == 0:
        return list()
    else:
        indices = indices[todo]
        
    return np.array_split(indices, size)

def _missing_files(args, sample, size, htmldir=None):
    """Simple task-specific wrapper on missing_files.

    """
    if args.coadds:
        suffix = 'coadds'
    elif args.custom_coadds:
        suffix = 'custom_coadds'
    elif args.ellipse:
        suffix = 'ellipse'
    elif args.sersic:
        suffix = 'sersic'
    elif args.sky:
        suffix = 'sky'
    elif args.htmlplots:
        suffix = 'html'
    else:
        suffix = ''        

    if suffix != '':
        groups = missing_files(sample, filetype=suffix, size=size, 
                               clobber=args.clobber, htmldir=htmldir)
    else:
        groups = []        

    return suffix, groups

def _start(galaxy, log=None, seed=None):
    if seed:
        print('Random seed = {}'.format(seed), flush=True)        
    print('Started working on galaxy {} at {}'.format(
        galaxy, time.asctime()), flush=True, file=log)

def _done(galaxy, err, t0, log=None):
    if err == 0:
        print('ERROR: galaxy {}; please check the logfile.'.format(galaxy), flush=True, file=log)
    print('Finished galaxy {} in {:.3f} minutes.'.format(
          galaxy, (time.time() - t0)/60), flush=True, file=log)

def _call_pipeline_coadds(onegal, galaxy, radius_mosaic, survey, pixscale,
                          nproc, force, debug, logfile):
    """Wrapper script to build the pipeline coadds."""
    t0 = time.time()
    if debug:
        _start(galaxy)
        err = legacyhalos.coadds.pipeline_coadds(onegal, galaxy=galaxy, radius_mosaic=radius_mosaic,
                                                 survey=survey, pixscale=pixscale,
                                                 nproc=nproc, force=force, cleanup=True)
        _done(galaxy, err, t0)
    else:
        with open(logfile, 'a') as log:
            with redirect_stdout(log), redirect_stderr(log):
                _start(galaxy, log=log)
                err = legacyhalos.coadds.pipeline_coadds(onegal, galaxy=galaxy, radius_mosaic=radius_mosaic,
                                                         survey=survey, pixscale=pixscale,
                                                         nproc=nproc, force=force, log=log, cleanup=True)
                _done(galaxy, err, t0, log=log)

def _call_custom_coadds(onegal, galaxy, radius_mosaic, survey, pixscale,
                        nproc, debug, logfile):
    """Wrapper script to build the pipeline coadds."""
    t0 = time.time()
    if debug:
        _start(galaxy)
        err = legacyhalos.coadds.custom_coadds(onegal, galaxy=galaxy, radius_mosaic=radius_mosaic,
                                               survey=survey, pixscale=pixscale, nproc=nproc)
        _done(galaxy, err, t0)
    else:
        with open(logfile, 'a') as log:
            with redirect_stdout(log), redirect_stderr(log):
                _start(galaxy, log=log)
                err = legacyhalos.coadds.custom_coadds(onegal, galaxy=galaxy, radius_mosaic=radius_mosaic,
                                                       survey=survey, pixscale=pixscale,
                                                       nproc=nproc, log=log)
                _done(galaxy, err, t0, log=log)
                
def _call_ellipse(onegal, galaxy, pixscale, nproc, verbose, debug, logfile):
    """Wrapper script to do ellipse-fitting.

    """
    import legacyhalos.ellipse
    zcolumn = 'Z_LAMBDA'
    
    t0 = time.time()
    if debug:
        _start(galaxy)
        err = legacyhalos.ellipse.legacyhalos_ellipse(onegal, pixscale=pixscale, nproc=nproc,
                                                      zcolumn=zcolumn,
                                                      verbose=verbose, debug=debug,
                                                      noellipsefit=True)
        _done(galaxy, err, t0)
    else:
        with open(logfile, 'a') as log:
            with redirect_stdout(log), redirect_stderr(log):
                _start(galaxy, log=log)
                err = legacyhalos.ellipse.legacyhalos_ellipse(onegal, pixscale=pixscale, nproc=nproc,
                                                              zcolumn=zcolumn,
                                                              verbose=verbose, debug=debug,
                                                              noellipsefit=True)
                _done(galaxy, err, t0, log=log)

def _call_htmlplots(onegal, galaxy, survey, pixscale, nproc, debug, clobber,
                    verbose, ccdqa, logfile, htmldir):
    """Wrapper script to build the pipeline coadds."""
    t0 = time.time()

    if debug:
        _start(galaxy)
        err = legacyhalos.html.make_plots(onegal, datadir=None, htmldir=htmldir,
                                          pixscale=pixscale, survey=survey, clobber=clobber,
                                          verbose=verbose, nproc=nproc,
                                          ccdqa=ccdqa, maketrends=False)
        _done(galaxy, err, t0)
    else:
        with open(logfile, 'a') as log:
            with redirect_stdout(log), redirect_stderr(log):
                _start(galaxy, log=log)
                err = legacyhalos.html.make_plots(onegal, datadir=None, htmldir=htmldir,
                                                  pixscale=pixscale, survey=survey, clobber=clobber,
                                                  verbose=verbose, nproc=nproc,
                                                  ccdqa=ccdqa, maketrends=False)
                _done(galaxy, err, t0, log=log)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--nproc', default=1, type=int, help='number of multiprocessing processes per MPI rank.')
    parser.add_argument('--pixscale', default=0.262, type=float, help='pixel scale (arcsec/pix).')
    parser.add_argument('--unwise-pixscale', default=2.75, type=float, help='unWISE pixel scale (arcsec/pix).')
    parser.add_argument('--galex-pixscale', default=1.5, type=float, help='unWISE pixel scale (arcsec/pix).')
    parser.add_argument('--mpi', action='store_true', help='Use MPI parallelism')

    parser.add_argument('--first', type=int, help='Index of first object to process.')
    parser.add_argument('--last', type=int, help='Index of last object to process.')

    parser.add_argument('--coadds', action='store_true', help='Build the pipeline coadds.')
    parser.add_argument('--custom-coadds', action='store_true', help='Build the custom coadds.')
    parser.add_argument('--unwise', action='store_true', help='Build the unWISE coadds.')
    parser.add_argument('--galex', action='store_true', help='Build the GALEX coadds.')
    parser.add_argument('--ellipse', action='store_true', help='Do the ellipse fitting.')
    parser.add_argument('--integrate', action='store_true', help='Integrate the surface brightness profiles.')
    parser.add_argument('--htmlplots', action='store_true', help='Build the HTML output.')
    parser.add_argument('--htmlindex', action='store_true', help='Build HTML index.html page.')

    parser.add_argument('--htmldir', type=str, help='Output directory for HTML files.')
    
    parser.add_argument('--ccdqa', action='store_true', help='Build the CCD-level diagnostics.')
    parser.add_argument('--force', action='store_true', help='Use with --coadds; ignore previous pickle files.')
    parser.add_argument('--count', action='store_true', help='Count how many objects are left to analyze and then return.')
    parser.add_argument('--nomakeplots', action='store_true', help='Do not remake the QA plots for the HTML pages.')

    parser.add_argument('--debug', action='store_true', help='Log to STDOUT and build debugging plots.')
    parser.add_argument('--verbose', action='store_true', help='Enable verbose output.')
    parser.add_argument('--clobber', action='store_true', help='Overwrite existing files.')                                
    args = parser.parse_args()

    if args.mpi:
        from mpi4py import MPI
        comm = MPI.COMM_WORLD
        rank, size = comm.rank, comm.size
    else:
        comm = None
        rank, size = 0, 1

    # Read and broadcast the sample.
    if rank == 0:
        print('Hack for the NASA/ADAP 2019 proposal.')
        sample = 
              
        sample = legacyhalos.io.read_paper2_sample(first=args.first, last=args.last)
        #sample = sample[[61, 74, 84]]
        #sample = sample[[8, 11, 136, 156, 157, 188, 214, 390, 603, 670, 871, 940]]
    else:
        sample = None

    if comm:
        sample = comm.bcast(sample, root=0)

    # Build the web-page; integrate the ellipse-fitting results.
    if args.htmlindex:
        if rank == 0:
            if args.hsc:
                legacyhalos.hsc.make_html(sample, survey=None, pixscale=args.pixscale, zcolumn='Z',
                                          nproc=args.nproc, clobber=args.clobber, makeplots=False,
                                          verbose=args.verbose, htmldir=args.htmldir)
            else:
                legacyhalos.html.make_html(sample, survey=None, pixscale=args.pixscale, zcolumn='Z_LAMBDA',
                                           nproc=args.nproc, clobber=args.clobber, makeplots=False,
                                           verbose=args.verbose, htmldir=args.htmldir)
        return

    if args.integrate:
        if rank == 0:
            if args.hsc:
                outfile = os.path.join(legacyhalos.hsc.hsc_dir(), 'profiles1d-flux.fits')
            else:
                # Temporary paper2 hack--
                outfile = os.path.join(legacyhalos.io.paper2_dir(data=True), 'paper2-profiles1d-flux.fits')
                
            if os.path.exists(outfile) and args.clobber is False:
                print('Output file {} exists; use --clobber.'.format(outfile))
                return
            
            results = legacyhalos.integrate.legacyhalos_integrate(
                sample, nproc=args.nproc, verbose=args.verbose, hsc=args.hsc)
            if args.hsc:
                cols = ['OBJECT_ID', 'RA', 'DEC', 'Z_SPEC']
            else:
                cols = ['MEM_MATCH_ID', 'RA', 'DEC', 'Z_LAMBDA', 'LAMBDA_CHISQ', 'ID_CENT',
                        'MW_TRANSMISSION_G', 'MW_TRANSMISSION_R', 'MW_TRANSMISSION_Z']
            out = hstack((sample[cols], results))
            print('Writing {}'.format(outfile))
            out.write(outfile, overwrite=True)
        return

    # Determine how many more objects we need to analyze and divide them
    # across ranks.
    groups, suffix = [], ''
    if rank == 0:
        suffix, groups = _missing_files(args, sample, size, args.htmldir)

    if comm:
        groups = comm.bcast(groups, root=0)
        suffix = comm.bcast(suffix, root=0)

    if len(groups) == 0:
        ntodo = 0
    else:
        ntodo = len(np.hstack(np.atleast_1d(groups)))
        
    if rank == 0:
        if ntodo == 0:
            print('{} for all {} galaxies are complete!'.format(
                suffix.upper(), len(sample)), flush=True)
            return
        else:
            print('{} left to do: {} / {} divided across {} group(s) and {} rank(s).'.format(
                suffix.upper(), ntodo, len(sample), len(groups), size), flush=True)

    if len(groups[rank]) == 0 or args.count:
        if len(groups[rank]) > 0 and args.debug:
            if args.hsc:
                galaxy, galaxydir = legacyhalos.hsc.get_galaxy_galaxydir(sample[groups], htmldir=args.htmldir)
            else:
                galaxy, galaxydir = legacyhalos.io.get_galaxy_galaxydir(sample[groups], htmldir=args.htmldir)
            for ii, dd in zip(groups[rank], galaxydir):
                print('  {} {}'.format(ii, dd))
            #[print('  {}'.format(dd)) for dd in np.atleast_1d(galaxydir)]
        return

    # Loop on the remaining objects.
    print('Starting {} {} on rank {} at {}'.format(len(groups[rank]), suffix.upper(),
                                                   rank, time.asctime()), flush=True)
    tall = time.time()
    for count, ii in enumerate(groups[rank]):
        onegal = sample[ii]
        if args.hsc:
            galaxy, galaxydir = legacyhalos.hsc.get_galaxy_galaxydir(onegal, htmldir=args.htmldir)
        else:
            galaxy, galaxydir = legacyhalos.io.get_galaxy_galaxydir(onegal, htmldir=args.htmldir)
        if not os.path.isdir(galaxydir):
            os.makedirs(galaxydir, exist_ok=True)

        #if (count+1) % 10 == 0:
        print('Rank {:03d} ({} / {}): {} (index {})'.format(
            rank, count+1, len(groups[rank]), galaxydir, ii), flush=True)

        if args.debug:
            logfile = None
        else:
            logfile = os.path.join(galaxydir, '{}-{}.log'.format(galaxy, suffix))
            #print('Logging to {} '.format(logfile), flush=True)
        
        # Need the cluster "radius" to build the coadds.
        if args.coadds or args.custom_coadds or args.sky or args.htmlplots:
            radius_mosaic_arcsec = legacyhalos.misc.cutout_radius_kpc(
                redshift=onegal['Z'], radius_kpc=RADIUS_CLUSTER_KPC) # [arcsec]

            survey = LegacySurveyData()
            survey.survey_dir = get_survey_dir(onegal)
            survey.output_dir = galaxydir

        if args.coadds:
            print('After DR8 do not use mjd-min and update OUTLIERS in coadds.py!')
            _call_pipeline_coadds(onegal, galaxy, radius_mosaic_arcsec, survey, args.pixscale,
                                  args.nproc, args.force, args.debug, logfile)
                    
        if args.custom_coadds or args.htmlplots:
            ccdsfile = os.path.join(survey.output_dir, '{}-ccds.fits'.format(galaxy))
            if not os.path.isfile(ccdsfile):
                if args.debug:
                    print('CCDs file {} not found.'.format(ccdsfile), flush=True)
                    print('ERROR: galaxy {}; please check the logfile.'.format(galaxy), flush=True)
                else:
                    with open(logfile, 'w') as log:
                        print('CCDs file {} not found.'.format(ccdsfile), flush=True, file=log)
                        print('ERROR: galaxy {}; please check the logfile.'.format(galaxy), flush=True, file=log)
                continue
            survey.ccds = survey.cleanup_ccds_table(fits_table(ccdsfile))

            # Check that coadds in all three grz bandpasses were generated in the
            # previous step.
            if ('g' not in survey.ccds.filter) or ('r' not in survey.ccds.filter) or ('z' not in survey.ccds.filter):
                if args.debug:
                    print('Missing grz coadds...skipping.', flush=True)
                    print('ERROR: galaxy {}; please check the logfile.'.format(galaxy), flush=True)
                else:
                    with open(logfile, 'w') as log:
                        print('Missing grz coadds...skipping.', flush=True, file=log)
                        print('ERROR: galaxy {}; please check the logfile.'.format(galaxy), flush=True, file=log)
                continue

        if args.custom_coadds:
            _call_custom_coadds(onegal, galaxy, radius_mosaic_arcsec, survey,
                                args.pixscale, args.nproc, args.debug, logfile)
                    
        if args.ellipse:
            _call_ellipse(onegal, galaxy, args.pixscale, args.nproc, args.verbose,
                          args.debug, logfile, args.hsc)
                        
        if args.sersic:
            _call_sersic(onegal, galaxy, galaxydir, args.seed, args.verbose,
                         args.debug, logfile, args.hsc)
            
        if args.sky:
            _call_sky(onegal, galaxy, galaxydir, survey, args.seed, args.nproc,
                      args.pixscale, args.verbose, args.debug, logfile)

        if args.htmlplots:
            _call_htmlplots(Table(onegal), galaxy, survey, args.pixscale, args.nproc,
                            args.debug, args.clobber, args.verbose, args.ccdqa, logfile,
                            args.hsc, args.htmldir)

    if rank == 0:
        print('Finished {} {} at {} after {:.3f} minutes'.format(
            ntodo, suffix.upper(), time.asctime(), (time.time() - tall) / 60 ), flush=True)
        groups = missing_files(sample, filetype=suffix, size=size, hsc=args.hsc, clobber=args.clobber)
        if len(groups) > 0:
            stilltodo = len(np.hstack(np.atleast_1d(groups)))
        else:
            stilltodo = 0
        print('{} left to do: {} / {}.'.format(suffix.upper(), stilltodo, ntodo), flush=True)

if __name__ == '__main__':
    main()
